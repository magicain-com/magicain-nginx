# Standalone Environment Configuration  
# Use: docker-compose up -d

version: '3.8'

services:
  # Nginx - Use production configuration with SSL
  nginx-proxy:
    build: .
    ports:
      - "80:80"
      - "443:443"
    networks:
      - magicain-app
    restart: unless-stopped
    volumes:
      - ./conf/standalone.conf:/etc/nginx/nginx.conf:ro
      - ./cert:/etc/nginx/cert:ro
      - ./logs/nginx:/var/log/nginx

  # Admin UI Frontend
  admin-ui:
    image: crpi-yzbqob8e5cxd8omc.cn-hangzhou.personal.cr.aliyuncs.com/magictensor/admin-ui:main
    ports:
      - "8080:8080"
    networks:
      - magicain-app
    restart: unless-stopped

  # Agent UI Frontend
  agent-ui:
    image: crpi-yzbqob8e5cxd8omc.cn-hangzhou.personal.cr.aliyuncs.com/magictensor/agent-ui:main-noda
    ports:
      - "8081:8081"
    networks:
      - magicain-app
    restart: unless-stopped

  # User UI Frontend
  user-ui:
    image: crpi-yzbqob8e5cxd8omc.cn-hangzhou.personal.cr.aliyuncs.com/magictensor/user-ui:main
    ports:
      - "8082:8082"
    networks:
      - magicain-app
    restart: unless-stopped

  # Cloud Backend
  cloud:
    image: crpi-yzbqob8e5cxd8omc.cn-hangzhou.personal.cr.aliyuncs.com/magictensor/cloud:main
    ports:
      - "48080:48080"
    networks:
      - magicain-app
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: standalone
      OTEL_SDK_DISABLED: "true"
      OTEL_TRACES_EXPORTER: "none"
      OTEL_METRICS_EXPORTER: "none"
      OTEL_LOGS_EXPORTER: "none"

  # PostgreSQL with PgVector
  postgres:
    image: docker.xuanyuan.run/pgvector/pgvector:pg16
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U magicain -d magicain"]
      interval: 3s
      timeout: 3s
      retries: 10
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: magicain
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/postgresql:/docker-entrypoint-initdb.d
    networks:
      - magicain-app

  # Redis
  redis:
    image: docker.xuanyuan.run/redis:7-alpine
    restart: unless-stopped
    command: >
      redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - magicain-app
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 3s
      timeout: 10s
      retries: 10

# Production-specific volumes with backup configuration
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/postgres
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/redis

networks:
  magicain-app:
    driver: bridge